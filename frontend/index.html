<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css" type="text/css" />
    <link rel="stylesheet" href="./info.css" type="text/css" />
    <link rel="stylesheet" href="./chat.css" type="text/css" />
    <title>AI Council</title>
</head>
<body>
    <main class="wrapper">
        <section class="info" id="sidebar" onclick="toggleSidebar()">
            <header>
                <span class="collapse-arrow">&gt;</span>
                <h1>> AI COUNCIL</h1>
            </header>
            <article class="council-status">
                <div class="analyst">
                    <h2>The Analyst</h2>
                    <span class="status" data-member="analyst">‚óè  Loading...</span>
                </div>
                <div class="creative">
                    <h2>The Creative One</h2>
                    <span class="status" data-member="creative">‚óè   Loading...</span>
                </div>
                <div class="critic">
                    <h2>The Critic</h2>
                    <span class="status" data-member="critic">‚óè  Loading...</span>
                </div> 
                <div class="pragmatist">
                    <h2>The Pragmatist</h2>
                    <span class="status" data-member="pragmatist">‚óè  Loading...</span>
                </div>
            </article>
        </section>
        <section class="chat">
            <header>
                <article class="toggle-controls">
                    <div class="toggle-item">
                        <label class="switch">
                            <input type="checkbox" id="websearchToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">üîç Web Search</span>
                    </div>
                    <div class="toggle-item">
                        <label class="switch">
                            <input type="checkbox" id="synthesizerToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">‚ö° Synthesizer</span>
                    </div>
                    <div class="toggle-item">
                        <label class="switch">
                            <input type="checkbox" id="consensusToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">Consensus Only</span>
                    </div>
                </article>
            </header>
            <article class="chat-messages" id="messages">
                <div class="message system">
                    <span class="prefix">&gt;</span> Council standing by.
                </div>
            </article>
            <form class="chat-input" id="chatForm">
                <input type="text" id="messageInput" placeholder="Enter your query..." autocomplete="off">
                <button type="submit">&gt;</button>
            </form>
        </section>
    </main>
</body>
</html>

<script defer>
    const API_BASE = 'http://localhost:3000';

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    }

    async function updateStatuses() {
        try {
            const response = await fetch(`${API_BASE}/health`);
            const data = await response.json();
            const council = data.council || {};

            // Map members to DOM elements
            const members = ['analyst', 'creative', 'critic', 'pragmatist'];
            members.forEach(member => {
                const statusEl = document.querySelector(`[data-member="${member}"]`);
                if (!statusEl) return;

                const status = council[member];
                statusEl.textContent = `‚óè  ${status?.toUpperCase() || 'UNKNOWN'}`;
                statusEl.className = `status ${status || 'unknown'}`;
            });
        } catch (error) {
            console.error('Failed to fetch statuses:', error);

            document.querySelectorAll('.status').forEach(el => {
                el.textContent = '‚óè  UNKNOWN';
                el.className = 'status unknown';
            });
        }
    }

    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const messagesContainer = document.getElementById('messages');
    const websearchToggle = document.getElementById('websearchToggle');
    const synthesizerToggle = document.getElementById('synthesizerToggle');
    const consensusToggle = document.getElementById('consensusToggle');

    function addMessage(text, type = 'system', member = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        if (member) {
            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = `[${member.toUpperCase()}]`;
            messageDiv.appendChild(header);
        }

        const content = document.createElement('div');
        if (type === 'system' || type === 'user')
            content.innerHTML = `<span class="prefix">&gt;</span> ${text}`;
        else
            content.textContent = text;

        messageDiv.appendChild(content);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message) return;

        addMessage(message, 'user');
        messageInput.value = '';

        const useSearch = websearchToggle.checked;
        const useSynthesizer = synthesizerToggle.checked;
        const isConsensusOnly = consensusToggle.checked;

        let statusParts = [];
        if (useSearch) statusParts.push('üîç Web Search');
        if (useSynthesizer) statusParts.push('‚ö° Synthesizer');
        if (isConsensusOnly) statusParts.push('üìä Consensus Only');

        const statusMsg = statusParts.length > 0 
            ? `Mode: ${statusParts.join(' + ')}` 
            : 'Mode: Direct responses';
        addMessage(statusMsg, 'system');

        try {
            if (isConsensusOnly) {
                addMessage(`Generating ${currentMode.toUpperCase()} consensus...`, 'system');
                
                const response = await fetch(`${API_BASE}/council/consensus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        useSearch: useSearch
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'system');
                } else {
                    addMessage(`Council Consensus (based on ${data.basedOn}):`, 'system');
                    addMessage(data.consensus, 'consensus');
                }
            } else {
                addMessage('Consulting council members...', 'system');
                
                const response = await fetch(`${API_BASE}/council`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        useSearch: useSearch,
                        synthesize: useSynthesizer
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'system');
                    return;
                }

                data.responses.forEach(resp => {
                    if (resp.error) {
                        addMessage(`${resp.member}: Error occurred`, 'system');
                    } else {
                        addMessage(resp.response, 'member', resp.model);
                    }
                });

                if (useSynthesizer && data.consensus) {
                    addMessage('--- CONSENSUS ---', 'system');
                    addMessage(data.consensus, 'consensus');
                } else if (useSynthesizer && data.consensusError) {
                    addMessage(`Consensus Error: ${data.consensusError}`, 'system');
                }
            }
        } catch (error) {
            addMessage('Failed to connect to council API. Make sure the server is running on port 3000.', 'system');
        }
    });

    updateStatuses();
    setInterval(updateStatuses, 10000);
</script>